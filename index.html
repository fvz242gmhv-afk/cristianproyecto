<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>The Rugrats World Boss Logs</title>

<style>
body{font-family:Arial;background:#0f0f0f;color:white;padding:20px;margin:0;overflow-x:hidden;}
h1{text-align:center;font-size:36px;background:linear-gradient(90deg,#e10600,#ff7b00,#e10600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:glow 3s infinite}
@keyframes glow{0%{text-shadow:0 0 5px #e10600}50%{text-shadow:0 0 20px #ff7b00}100%{text-shadow:0 0 5px #e10600}}
h2{text-align:center;color:#e10600}
.container{max-width:1200px;margin:auto;background:#1a1a1a;padding:20px;border-radius:12px;border:2px solid #e10600;position:relative;z-index:1}
.member{display:grid;grid-template-columns:280px 1fr 80px 1fr;gap:8px;margin-bottom:8px;align-items:center}
.role{display:flex;align-items:center;gap:6px;font-size:13px}
.role img{width:26px;height:26px;border-radius:4px}
input{padding:6px;border-radius:6px;border:none}
button{padding:8px;border:none;border-radius:6px;cursor:pointer}
.save{width:100%;margin-top:15px;padding:12px;background:#e10600;color:white;font-size:16px}
.edit{background:#444;color:white}
.delete{background:#b00020;color:white}
.preview{max-width:100%;border-radius:6px;cursor:pointer;border:1px solid #444;margin-top:8px}
.run{margin-top:10px;background:#111;border-radius:8px;padding:10px}
.run-header{display:flex;justify-content:space-between;font-weight:bold}
.run-details{display:none;margin-top:8px}
.dead{color:#ff4d4d}
.alive{color:#4ade80}
.killedby{color:#aaa;font-size:13px}
.stats{margin-top:25px;background:#111;padding:15px;border-radius:10px}
.highlight{color:#ffd700;text-shadow:0 0 10px #ffd700;font-weight:bold}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);justify-content:center;align-items:center;z-index:999}
.modal img{max-width:95%;max-height:95%;border-radius:10px}
.mini-btn{
  padding:4px 8px;
  background:#e10600;
  color:white;
  border-radius:4px;
  text-decoration:none;
  font-size:11px;
  white-space:nowrap;
}
.label-text{
  font-size:14px;
  margin-bottom:4px;
  color:#ffd700;
}
.image-section{margin-bottom:20px;}
.image-title{
  font-size:15px;
  color:#ffd700;
  margin:15px 0 8px 0;
  font-weight:bold;
}
.download-btn{
  display:inline-block;
  padding:8px 12px;
  background:#e10600;
  color:white;
  border-radius:6px;
  text-decoration:none;
  margin-top:10px;
  font-size:14px;
}
</style>
</head>

<body>

<h1>The Rugrats World Boss Logs</h1>

<div class="container">

<div id="party"></div>

<!-- Primera imagen -->
<div class="image-section">
  <div class="label-text">IMAGEN 1 - LOOT COMPLETO O PRINCIPAL</div>
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
    <input id="imageUrl1" placeholder="Pega aqu√≠ el URL directa de la imagen 1" style="flex:1">
    <a href="https://postimages.org/" target="_blank" class="mini-btn">Subir imagen</a>
  </div>
  <img id="imagePreview1" class="preview" style="display:none">
</div>

<!-- Segunda imagen -->
<div class="image-section">
  <div class="label-text">IMAGEN 2 - DPS METER (OPCIONAL)</div>
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
    <input id="imageUrl2" placeholder="Pega aqu√≠ el URL directa de la imagen 2 (opcional)" style="flex:1">
    <a href="https://postimages.org/" target="_blank" class="mini-btn">Subir imagen</a>
  </div>
  <img id="imagePreview2" class="preview" style="display:none">
</div>

<!-- Archivo adjunto por URL - Solo bot√≥n de catbox -->
<div class="image-section">
  <div class="label-text">ARCHIVO REGISTRO LOOT - sube tu archivo y pega el url.</div>
  <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
    <input id="fileUrl" placeholder="Pega aqu√≠ el URL directo del archivo" style="flex:1">
    <a href="https://catbox.moe/" target="_blank" class="mini-btn">Subir a catbox</a>
  </div>
  <div style="font-size:13px;color:#aaa;">
    Usa <strong>catbox.moe</strong> ‚Üí permite .txt, .log, .csv, .pdf, .zip sin registro y da enlace directo.
  </div>
</div>

<input id="silver" type="text" placeholder="Total Silver" style="width:100%;margin-top:10px" value="4.5m">

<button class="save" id="saveBtn">Guardar Run</button>

<h2>Runs Guardadas</h2>
<div id="runs"><p style="text-align:center;color:#aaa;">Cargando runs... (si no aparece nada, revisa la consola)</p></div>

<h2>Estad√≠sticas</h2>
<div class="stats">
‚ò†Ô∏è M√°s muertes: <strong id="mostDeaths">-</strong><br><br>
üìù M√°s jugado: <strong id="mostPlayed">-</strong><br><br>
üõ°Ô∏è Main Tank M√°s Activo: <strong id="mainTank" class="highlight">-</strong><br><br>
‚òëÔ∏è Total Silver Loot: <strong id="totalSilver">-</strong><br><br>
</div>

</div>

<div class="modal" id="imageModal" onclick="this.style.display='none'">
<img id="modalImg">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDSxZILNH92QqkfnQeSpYZeboqylAo_6S0",
  authDomain: "sushitime-b84fc.firebaseapp.com",
  databaseURL: "https://sushitime-b84fc-default-rtdb.firebaseio.com",
  projectId: "sushitime-b84fc",
  storageBucket: "sushitime-b84fc.firebasestorage.app",
  messagingSenderId: "821112951317",
  appId: "1:821112951317:web:0f104e0aea3b3d14aab41c",
  measurementId: "G-CBH676TZ3S"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

signInAnonymously(auth)
  .then(() => console.log("Autenticado an√≥nimamente con √©xito"))
  .catch(err => console.error("Error en autenticaci√≥n:", err));

const partyDiv = document.getElementById("party");
const imageUrlInput1 = document.getElementById("imageUrl1");
const imageUrlInput2 = document.getElementById("imageUrl2");
const fileUrlInput = document.getElementById("fileUrl");
const imagePreview1 = document.getElementById("imagePreview1");
const imagePreview2 = document.getElementById("imagePreview2");
const silverInput = document.getElementById("silver");
const saveBtn = document.getElementById("saveBtn");
const runsDiv = document.getElementById("runs");
const mostDeathsEl = document.getElementById("mostDeaths");
const mostPlayedEl = document.getElementById("mostPlayed");
const mainTankEl = document.getElementById("mainTank");
const totalSilverEl = document.getElementById("totalSilver");
const modalImg = document.getElementById("modalImg");
const imageModal = document.getElementById("imageModal");

let editingRunId = null;

function pedirContrase√±a() {
  const entrada = prompt("Ingresa la contrase√±a para realizar esta acci√≥n:");
  if (entrada === null) return false;
  const hashEsperado = [49,53,57,56,55].map(c => String.fromCharCode(c)).join('');
  return entrada === hashEsperado;
}

const roles = [
  ["(111) Main Tank", "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRPm9NhzKzVrl7MrCGwW5GQdSkaPeZDKkmfZbVVQyOlXOk06moNeOY0IBgm&s"],
  ["(222) Off Tank", "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS_bMRn1s0zb5NMXzx9pKA9Dt5vZSt16pvZMN_RaMkF5kw1aWkr5TYcoVc&s"],
  ["(333) Healer", "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQVyXHLZlSGSoLTaejlh8wLHh0Mv3BDSA2PipLqvnn0pSGLQUmBSN8gngIg&s"],
  ["(444) Sc", "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSAm5jnLqjMAMgMsPZd5rQUv1lzDnDsx4BHc0wX9sV2XCEyVcl_ZDDvb-A2&s"],
  ["(555) Truebolt hammer", "https://render.albiononline.com/v1/item/T8_2H_HAMMER_CRYSTAL@2.png"],
  ["(666)", "https://render.albiononline.com/v1/item/T8_2H_SCYTHE_CRYSTAL.png"],
  ["(677)", "https://render.albiononline.com/v1/item/T8_2H_SCYTHE_CRYSTAL.png"],
  ["(688)", "https://render.albiononline.com/v1/item/T8_2H_SCYTHE_CRYSTAL.png"],
  ["(688)", "https://render.albiononline.com/v1/item/T8_2H_SCYTHE_CRYSTAL.png"],
  ["(777) Rootbound", "https://render.albiononline.com/v1/item/T8_2H_SHAPESHIFTER_SET2.png"]
];

roles.forEach((role, i) => {
  const playerNumber = i + 1;
  const placeholderText = playerNumber === 9 ? "Jugador 9" : playerNumber === 10 ? "Jugador 10" : `Jugador ${playerNumber}`;
  
  partyDiv.innerHTML += `
    <div class="member">
      <div class="role"><img src="${role[1]}" alt=""> ${role[0]}</div>
      <input class="player" placeholder="${placeholderText}">
      <label><input type="checkbox" class="deadCheck"> Muerto</label>
      <input class="killedBy" placeholder="Killed by">
    </div>`;
});

imageUrlInput1.oninput = () => {
  if (imageUrlInput1.value.trim()) {
    imagePreview1.src = imageUrlInput1.value.trim();
    imagePreview1.style.display = "block";
  } else {
    imagePreview1.style.display = "none";
  }
};

imageUrlInput2.oninput = () => {
  if (imageUrlInput2.value.trim()) {
    imagePreview2.src = imageUrlInput2.value.trim();
    imagePreview2.style.display = "block";
  } else {
    imagePreview2.style.display = "none";
  }
};

imagePreview1.onclick = imagePreview2.onclick = (e) => {
  modalImg.src = e.target.src;
  imageModal.style.display = "flex";
};

saveBtn.onclick = async () => {
  const players = document.querySelectorAll(".player");
  const deadChecks = document.querySelectorAll(".deadCheck");
  const killedByInputs = document.querySelectorAll(".killedBy");

  const party = [];
  players.forEach((input, i) => {
    const name = input.value.trim();
    if (name) {
      party.push({
        name,
        dead: deadChecks[i].checked,
        killedBy: killedByInputs[i].value.trim() || null,
        role: roles[i][0]
      });
    }
  });

  if (party.length === 0) return alert("Ingresa al menos un jugador");

  const data = {
    timestamp: Date.now(),
    silver: silverInput.value.trim() || "4.5m",
    imageUrl1: imageUrlInput1.value.trim() || null,
    imageUrl2: imageUrlInput2.value.trim() || null,
    fileUrl: fileUrlInput.value.trim() || null,
    party
  };

  try {
    if (editingRunId) {
      await update(ref(db, `runs/${editingRunId}`), data);
      alert("Run actualizada!");
      editingRunId = null;
      saveBtn.textContent = "Guardar Run";
    } else {
      await push(ref(db, "runs"), data);
      alert("Run guardada!");
    }
    resetForm();
  } catch (err) {
    console.error("Error al guardar:", err);
    alert("Error al guardar: " + err.message);
  }
};

function resetForm() {
  document.querySelectorAll(".player").forEach(i => i.value = "");
  document.querySelectorAll(".deadCheck").forEach(c => c.checked = false);
  document.querySelectorAll(".killedBy").forEach(k => k.value = "");
  silverInput.value = "4.5m";
  imageUrlInput1.value = "";
  imageUrlInput2.value = "";
  fileUrlInput.value = "";
  imagePreview1.style.display = "none";
  imagePreview2.style.display = "none";
}

const runsRef = ref(db, "runs");
onValue(runsRef, (snapshot) => {
  const data = snapshot.val();
  runsDiv.innerHTML = "";

  if (!data) {
    runsDiv.innerHTML = '<p style="text-align:center;color:#aaa;">A√∫n no hay runs guardadas</p>';
    mostDeathsEl.textContent = "-";
    mostPlayedEl.textContent = "-";
    mainTankEl.textContent = "-";
    totalSilverEl.textContent = "-";
    return;
  }

  let deaths = {}, plays = {}, tank = {}, totalSilver = 0;

  snapshot.forEach(child => {
    const run = child.val();
    const key = child.key;
    if (!run || !run.party) return;

    let silverStr = run.silver || "0";
    let silverNum = 0;
    if (silverStr.toLowerCase().endsWith("m")) silverNum = parseFloat(silverStr) * 1_000_000;
    else if (silverStr.toLowerCase().endsWith("k")) silverNum = parseFloat(silverStr) * 1_000;
    else silverNum = parseFloat(silverStr) || 0;
    totalSilver += silverNum;

    const partyArray = Array.isArray(run.party) ? run.party : [];

    const detailsHTML = partyArray.map(p => {
      const imgSrc = roles.find(r => r[0] === p.role)?.[1] || '';
      return `
        <div class="${p.dead ? 'dead' : 'alive'}" style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
          <img src="${imgSrc}" alt="${p.role}" style="width:26px;height:26px;border-radius:4px">
          <strong>${p.name}</strong> (${p.role})
          ${p.dead && p.killedBy ? `<span class="killedby">‚Äî killed by ${p.killedBy}</span>` : ''}
        </div>
      `;
    }).join("");

    let imagesHTML = "";
    if (run.imageUrl1) {
      imagesHTML += `
        <div>
          <div class="image-title">Loot Completo / Principal</div>
          <img src="${run.imageUrl1}" class="preview" onclick="openImage('${run.imageUrl1}')">
        </div>`;
    }
    if (run.imageUrl2) {
      imagesHTML += `
        <div>
          <div class="image-title">DPS Meter</div>
          <img src="${run.imageUrl2}" class="preview" onclick="openImage('${run.imageUrl2}')">
        </div>`;
    }
    if (run.fileUrl) {
      const fileName = decodeURIComponent(run.fileUrl.split('/').pop().split('?')[0]) || 'archivo_adjunto';
      imagesHTML += `
        <div>
          <div class="image-title">Registro Loot</div>
          <a href="${run.fileUrl}" target="_blank" class="download-btn">‚¨á Descargar ${fileName}</a>
        </div>`;
    }

    runsDiv.innerHTML += `
      <div class="run">
        <div class="run-header">
          <span>${new Date(run.timestamp).toLocaleString()} ‚Äî <strong>Main Tank: ${partyArray[0]?.name || 'Desconocido'}</strong></span>
          <span>${run.silver}</span>
        </div>
        <div style="margin-top:8px; display:flex; gap:6px;">
          <button class="edit" onclick="protectedEdit('${key}')">Editar</button>
          <button class="delete" onclick="protectedDelete('${key}')">Borrar</button>
          <button onclick="toggleDetails(this)">Ver detalles</button>
        </div>
        <div class="run-details" style="display:none;">
          ${imagesHTML}
          <div style="margin-top:20px;">${detailsHTML}</div>
        </div>
      </div>`;

    partyArray.forEach(p => {
      if (!p) return;
      plays[p.name] = (plays[p.name] || 0) + 1;
      if (p.dead) deaths[p.name] = (deaths[p.name] || 0) + 1;
      if (p.role?.includes("Main Tank")) tank[p.name] = (tank[p.name] || 0) + 1;
    });
  });

  const topDeaths = Object.entries(deaths).sort((a,b)=>b[1]-a[1])[0];
  const topPlayed = Object.entries(plays).sort((a,b)=>b[1]-a[1])[0];
  const topTank = Object.entries(tank).sort((a,b)=>b[1]-a[1])[0];

  mostDeathsEl.textContent = topDeaths ? `${topDeaths[0]} (${topDeaths[1]})` : "-";
  mostPlayedEl.textContent = topPlayed ? `${topPlayed[0]} (${topPlayed[1]})` : "-";
  mainTankEl.textContent = topTank ? `${topTank[0]} (${topTank[1]})` : "-";
  totalSilverEl.textContent = `${(totalSilver/1_000_000).toFixed(2)}m`;
}, (error) => {
  runsDiv.innerHTML = `<p style="color:red;text-align:center;">Error al cargar runs: ${error.message}</p>`;
});

window.protectedEdit = (id) => {
  if (pedirContrase√±a()) {
    editRun(id);
  }
};

window.protectedDelete = (id) => {
  if (pedirContrase√±a()) {
    deleteRun(id);
  }
};

window.toggleDetails = (button) => {
  const details = button.closest('.run').querySelector('.run-details');
  details.style.display = details.style.display === 'block' ? 'none' : 'block';
};

window.editRun = (id) => {
  onValue(ref(db, `runs/${id}`), snap => {
    const run = snap.val();
    if (!run || !run.party) {
      alert("Run inv√°lida o incompleta.");
      return;
    }
    editingRunId = id;
    saveBtn.textContent = "Actualizar Run";

    const players = document.querySelectorAll(".player");
    const deadChecks = document.querySelectorAll(".deadCheck");
    const killedBy = document.querySelectorAll(".killedBy");

    run.party.forEach((p, i) => {
      if (players[i]) {
        players[i].value = p.name || "";
        deadChecks[i].checked = p.dead || false;
        killedBy[i].value = p.killedBy || "";
      }
    });

    silverInput.value = run.silver || "4.5m";
    imageUrlInput1.value = run.imageUrl1 || "";
    imageUrlInput2.value = run.imageUrl2 || "";
    fileUrlInput.value = run.fileUrl || "";

    if (run.imageUrl1) {
      imagePreview1.src = run.imageUrl1;
      imagePreview1.style.display = "block";
    } else {
      imagePreview1.style.display = "none";
    }
    if (run.imageUrl2) {
      imagePreview2.src = run.imageUrl2;
      imagePreview2.style.display = "block";
    } else {
      imagePreview2.style.display = "none";
    }
  }, { onlyOnce: true });
};

window.deleteRun = (id) => {
  remove(ref(db, `runs/${id}`))
    .then(() => alert("Run borrada"))
    .catch(err => alert("Error: " + err.message));
};

window.openImage = (url) => {
  modalImg.src = url;
  imageModal.style.display = "flex";
};
</script>
</body>
</html>
